<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jeu de Cartes Smile - Multijoueur</title>
    <script src="https://cdn.socket.io/4.5.4/socket.io.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        .card {
            transition: all 0.3s ease;
        }
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 20px rgba(0,0,0,0.2);
        }
        .pulse {
            animation: pulse 2s infinite;
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .modal {
            backdrop-filter: blur(4px);
        }
        .category-section {
            border: 2px solid #e5e7eb;
            border-radius: 0.5rem;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        .salary-card-selectable {
            cursor: pointer;
            transition: all 0.2s;
        }
        .salary-card-selectable:hover {
            transform: scale(1.05);
        }
        .salary-card-selected {
            border: 3px solid #10b981 !important;
            background-color: #d1fae5 !important;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-purple-400 to-pink-500 min-h-screen">
    
    <!-- Modal de s√©lection de salaires pour achat -->
    <div id="salary-selection-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                üí∞ S√©lectionner les salaires √† d√©penser
            </h2>
            
            <div id="acquisition-card-display" class="mb-6 p-4 bg-green-50 rounded-lg border-2 border-green-300"></div>
            
            <div class="mb-4 p-4 bg-blue-50 rounded-lg">
                <div class="flex justify-between items-center text-lg font-semibold">
                    <span>Co√ªt minimum :</span>
                    <span class="text-blue-600" id="required-cost">0</span>
                </div>
                <div class="flex justify-between items-center text-lg font-semibold mt-2">
                    <span>Montant s√©lectionn√© :</span>
                    <span class="text-green-600" id="selected-amount">0</span>
                </div>
                <div class="mt-2 text-sm text-gray-600">
                    <span id="payment-status">S√©lectionnez vos salaires (minimum requis)</span>
                </div>
            </div>
            
            <div class="mb-6">
                <h3 class="font-semibold mb-3 text-gray-700">Vos ressources disponibles :</h3>
                <div id="available-salaries-list" class="grid grid-cols-2 sm:grid-cols-3 gap-2"></div>
            </div>
            
            <div class="flex gap-3">
                <button onclick="confirmSalarySelection()" id="confirm-salary-btn" class="flex-1 bg-green-500 text-white py-3 px-6 rounded-lg hover:bg-green-600 transition-all font-semibold disabled:opacity-50 disabled:cursor-not-allowed" disabled>
                    ‚úÖ Confirmer l'achat
                </button>
                <button onclick="closeSalaryModal()" class="flex-1 bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-all font-semibold">
                    Annuler
                </button>
            </div>
        </div>
    </div>

    <!-- Modal de s√©lection de cible pour malus -->
    <div id="hardship-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                ‚ö†Ô∏è Choisir une victime
            </h2>
            <div id="hardship-card-display" class="mb-6 p-4 bg-red-50 rounded-lg border-2 border-red-300"></div>
            <div class="mb-6">
                <h3 class="font-semibold mb-3 text-gray-700">Joueurs disponibles :</h3>
                <div id="target-players-list" class="space-y-2"></div>
            </div>
            <button onclick="closeHardshipModal()" class="w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-all font-semibold">
                Annuler
            </button>
        </div>
    </div>

    <!-- Modal Anniversaire - Don de salaire -->
    <div id="birthday-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                üéÇ Anniversaire !
            </h2>
            <p id="birthday-message" class="text-center mb-4 text-gray-600"></p>
            <div class="mb-6">
                <h3 class="font-semibold mb-3 text-gray-700">Choisissez un salaire √† offrir :</h3>
                <div id="birthday-salaries-list" class="grid grid-cols-2 gap-2"></div>
            </div>
        </div>
    </div>

    <!-- Modal Troc - Choix du joueur -->
    <div id="troc-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                üîÑ Troc
            </h2>
            <p class="text-center mb-4 text-gray-600">Choisissez un joueur avec qui √©changer une carte al√©atoire</p>
            <div id="troc-players-list" class="space-y-2"></div>
            <button onclick="closeTrocModal()" class="mt-4 w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-all font-semibold">
                Annuler
            </button>
        </div>
    </div>

    <!-- Modal Piston - Choix du m√©tier -->
    <div id="piston-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                üéØ Piston
            </h2>
            <p class="text-center mb-4 text-gray-600">Choisissez un m√©tier √† poser sans condition d'√©tudes</p>
            <div id="piston-jobs-list" class="grid grid-cols-2 gap-3"></div>
            <button onclick="closePistonModal()" class="mt-4 w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-all font-semibold">
                Annuler
            </button>
        </div>
    </div>

    <!-- Modal Vengeance - Choix de l'attaque et de la cible -->
    <div id="vengeance-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                ‚öîÔ∏è Vengeance
            </h2>
            <div class="mb-6">
                <h3 class="font-semibold mb-3 text-gray-700">Vos attaques re√ßues :</h3>
                <div id="vengeance-hardships-list" class="space-y-2 mb-4"></div>
            </div>
            <div id="vengeance-targets-container" class="hidden">
                <h3 class="font-semibold mb-3 text-gray-700">Choisir la victime :</h3>
                <div id="vengeance-targets-list" class="space-y-2"></div>
            </div>
            <button onclick="closeVengeanceModal()" class="mt-4 w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-all font-semibold">
                Annuler
            </button>
        </div>
    </div>

    <!-- Modal Chance - Choix parmi 3 cartes -->
    <div id="chance-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-3xl w-full">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                üçÄ Chance
            </h2>
            <p class="text-center mb-4 text-gray-600">Choisissez une carte parmi les 3 suivantes</p>
            <div id="chance-cards-list" class="grid grid-cols-3 gap-4"></div>
        </div>
    </div>

    <!-- Modal Arc-en-ciel - Mode sp√©cial -->
    <div id="arc-en-ciel-banner" class="hidden fixed top-20 left-1/2 transform -translate-x-1/2 bg-gradient-to-r from-pink-500 via-purple-500 to-blue-500 text-white px-8 py-4 rounded-lg shadow-2xl z-40">
        <div class="text-center">
            <div class="text-2xl font-bold mb-2">üåà Mode Arc-en-ciel actif !</div>
            <div class="text-sm mb-3">Vous pouvez jouer jusqu'√† 3 cartes - <span id="arc-remaining">3</span> restante(s)</div>
            <button onclick="finishArcEnCiel()" class="bg-white text-purple-600 px-6 py-2 rounded-lg font-semibold hover:bg-gray-100">
                ‚úÖ Terminer et repiocher
            </button>
        </div>
    </div>

    <!-- Modal √âtoile filante - Choix dans la d√©fausse -->
    <div id="star-modal" class="modal hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-6xl w-full max-h-[90vh] overflow-y-auto">
            <h2 class="text-2xl font-bold text-center mb-4 text-gray-800">
                ‚≠ê √âtoile filante
            </h2>
            <p class="text-center mb-4 text-gray-600">Choisissez une carte de la d√©fausse √† poser (doit respecter les r√®gles)</p>
            <div id="star-discard-list" class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3"></div>
            <button onclick="closeStarModal()" class="mt-4 w-full bg-gray-500 text-white py-3 px-6 rounded-lg hover:bg-gray-600 transition-all font-semibold">
                Annuler
            </button>
        </div>
    </div>

    <!-- √âcran de menu -->
    <div id="menu-screen" class="flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <div class="flex justify-center mb-6">
                <span class="text-6xl">üòä</span>
            </div>
            <h1 class="text-4xl font-bold text-center mb-8 text-gray-800">Jeu de Cartes Smile</h1>
            
            <div class="space-y-4">
                <button onclick="showCreateGame()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 px-6 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 font-semibold text-lg shadow-lg">
                    üéÆ Cr√©er une partie
                </button>
                
                <button onclick="showJoinGame()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-4 px-6 rounded-lg hover:from-blue-600 hover:to-cyan-600 transition-all transform hover:scale-105 font-semibold text-lg shadow-lg">
                    üö™ Rejoindre une partie
                </button>
            </div>
        </div>
    </div>

    <!-- √âcran cr√©ation de partie -->
    <div id="create-screen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <button onclick="backToMenu()" class="mb-4 text-gray-600 hover:text-gray-800">‚Üê Retour</button>
            
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Cr√©er une partie</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Votre nom:</label>
                    <input type="text" id="host-name" value="Joueur 1" 
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Nombre de joueurs:</label>
                    <select id="num-players" class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                        <option value="2">2 joueurs</option>
                        <option value="3">3 joueurs</option>
                        <option value="4">4 joueurs</option>
                        <option value="5">5 joueurs</option>
                    </select>
                </div>
                
                <button onclick="createGame()" class="w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 px-6 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 font-semibold text-lg shadow-lg">
                    Cr√©er
                </button>
            </div>
        </div>
    </div>

    <!-- √âcran rejoindre partie -->
    <div id="join-screen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-md w-full">
            <button onclick="backToMenu()" class="mb-4 text-gray-600 hover:text-gray-800">‚Üê Retour</button>
            
            <h2 class="text-2xl font-bold text-center mb-6 text-gray-800">Rejoindre une partie</h2>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Votre nom:</label>
                    <input type="text" id="join-name" value="Joueur" 
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none">
                </div>
                
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">Code de la partie:</label>
                    <input type="text" id="game-code" placeholder="Ex: abc123" 
                           class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-purple-500 focus:outline-none uppercase">
                </div>
                
                <button onclick="joinGame()" class="w-full bg-gradient-to-r from-blue-500 to-cyan-500 text-white py-4 px-6 rounded-lg hover:from-blue-600 hover:to-cyan-600 transition-all transform hover:scale-105 font-semibold text-lg shadow-lg">
                    Rejoindre
                </button>
            </div>
        </div>
    </div>

    <!-- √âcran salle d'attente -->
    <div id="lobby-screen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-2xl w-full">
            <h2 class="text-3xl font-bold text-center mb-2 text-gray-800">Salle d'attente</h2>
            <div class="text-center mb-6">
                <p class="text-gray-600 mb-2">Code de la partie:</p>
                <div class="inline-block bg-purple-100 px-6 py-3 rounded-lg">
                    <span id="lobby-game-code" class="text-3xl font-bold text-purple-600"></span>
                </div>
                <p class="text-sm text-gray-500 mt-2">Partagez ce code avec vos amis</p>
            </div>
            
            <div class="mb-6">
                <h3 class="font-bold mb-3 text-lg">Joueurs connect√©s:</h3>
                <div id="lobby-players" class="space-y-2"></div>
            </div>
            
            <div id="start-button-container" class="hidden">
                <button onclick="startGame()" class="w-full bg-gradient-to-r from-green-500 to-emerald-500 text-white py-4 px-6 rounded-lg hover:from-green-600 hover:to-emerald-600 transition-all transform hover:scale-105 font-semibold text-lg shadow-lg">
                    üöÄ D√©marrer la partie
                </button>
            </div>
            
            <div class="text-center text-gray-600 text-sm mt-4">
                <span id="players-count">En attente de joueurs...</span>
            </div>
        </div>
    </div>

    <!-- √âcran de jeu -->
    <div id="game-screen" class="hidden p-4 max-w-7xl mx-auto">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <div class="flex justify-between items-center flex-wrap gap-2">
                <h2 id="current-player-name" class="text-2xl font-bold text-gray-800"></h2>
                <div class="flex gap-4 items-center flex-wrap">
                    <div class="bg-blue-500 text-white px-4 py-2 rounded">
                        Pioche: <span id="deck-count">0</span>
                    </div>
                    <div class="bg-gray-500 text-white px-4 py-2 rounded">
                        D√©fausse: <span id="discard-count">0</span>
                    </div>
                </div>
            </div>
            <div id="message" class="mt-2 bg-yellow-100 border-l-4 border-yellow-500 p-2 text-sm"></div>
        </div>

        <!-- Derni√®re carte d√©fauss√©e -->
        <div id="last-discard-container" class="bg-white rounded-lg shadow-lg p-4 mb-4 hidden">
            <h3 class="font-bold mb-2">üóëÔ∏è Derni√®re carte d√©fauss√©e</h3>
            <div id="last-discard-card"></div>
        </div>

        <!-- Scores des joueurs -->
        <div id="players-scores" class="grid grid-cols-2 md:grid-cols-5 gap-2 mb-4"></div>

        <!-- Actions disponibles -->
        <div id="actions-panel" class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <h3 class="font-bold mb-3">üéØ Actions disponibles</h3>
            <div class="flex gap-3 flex-wrap">
                <button onclick="drawCard('deck')" id="draw-deck-btn" class="flex-1 min-w-[200px] bg-blue-500 text-white px-6 py-3 rounded-lg hover:bg-blue-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                    üìö Piocher dans la pioche
                </button>
                <button onclick="drawCard('discard')" id="draw-discard-btn" class="flex-1 min-w-[200px] bg-gray-500 text-white px-6 py-3 rounded-lg hover:bg-gray-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                    üóëÔ∏è Piocher dans la d√©fausse
                </button>
                <button onclick="skipTurn()" id="skip-turn-btn" class="flex-1 min-w-[200px] bg-orange-500 text-white px-6 py-3 rounded-lg hover:bg-orange-600 font-semibold disabled:opacity-50 disabled:cursor-not-allowed">
                    ‚è≠Ô∏è Passer mon tour
                </button>
            </div>
        </div>

        <!-- Main du joueur -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <h3 class="font-bold mb-3">Votre main (<span id="hand-count">0</span> cartes)</h3>
            <div id="player-hand" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Cartes pos√©es par cat√©gories -->
        <div class="bg-white rounded-lg shadow-lg p-4 mb-4">
            <h3 class="font-bold mb-3">Vos cartes pos√©es</h3>
            
            <!-- Vie professionnelle -->
            <div class="category-section bg-blue-50">
                <h4 class="font-semibold text-blue-800 mb-2">üíº Vie professionnelle</h4>
                <div id="player-vie-pro" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- Vie personnelle -->
            <div class="category-section bg-pink-50">
                <h4 class="font-semibold text-pink-800 mb-2">üíï Vie personnelle</h4>
                <div id="player-vie-perso" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- Acquisitions -->
            <div class="category-section bg-green-50">
                <h4 class="font-semibold text-green-800 mb-2">üè† Acquisitions</h4>
                <div id="player-acquisitions" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- Salaire d√©pens√© -->
            <div class="category-section bg-gray-50">
                <h4 class="font-semibold text-gray-800 mb-2">üí∏ Salaires d√©pens√©s</h4>
                <div id="player-salaire-depense" class="flex flex-wrap gap-2"></div>
            </div>
            
            <!-- Cartes sp√©ciales -->
            <div class="category-section bg-yellow-50">
                <h4 class="font-semibold text-yellow-800 mb-2">‚≠ê Cartes sp√©ciales</h4>
                <div id="player-speciales" class="flex flex-wrap gap-2"></div>
            </div>
        </div>

        <!-- Attaques re√ßues -->
        <div id="hardships-received-container" class="bg-red-50 rounded-lg shadow-lg p-4 mb-4 border-2 border-red-300">
            <h3 class="font-bold mb-3 text-red-700">üí• Attaques re√ßues sur moi</h3>
            <div id="hardships-received" class="flex flex-wrap gap-2"></div>
        </div>

        <!-- Autres joueurs -->
        <div id="other-players" class="grid grid-cols-1 md:grid-cols-2 gap-4"></div>
    </div>

    <!-- √âcran de fin -->
    <div id="end-screen" class="hidden flex items-center justify-center min-h-screen p-4">
        <div class="bg-white rounded-xl shadow-2xl p-8 max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="flex justify-center mb-6">
                <span class="text-8xl">üéâ</span>
            </div>
            <h1 class="text-4xl font-bold text-center mb-2 text-gray-800">Partie Termin√©e !</h1>
            <h2 id="winner-name" class="text-2xl font-bold text-center mb-8 text-purple-600"></h2>
            <div id="final-scores" class="space-y-4"></div>
            <button onclick="location.reload()" class="mt-8 w-full bg-gradient-to-r from-purple-500 to-pink-500 text-white py-4 px-6 rounded-lg hover:from-purple-600 hover:to-pink-600 transition-all transform hover:scale-105 font-semibold text-lg shadow-lg">
                Nouvelle Partie
            </button>
        </div>
    </div>

    <script>
        const socket = io();
        let gameId = null;
        let currentGame = null;
        let myPlayerId = null;
        let isHost = false;
        let pendingHardshipCard = null;
        let fromDiscard = false;
        
        // Variables pour la s√©lection de salaires
        let pendingAcquisitionCard = null;
        let requiredCost = 0;
        let selectedSalaries = [];
        let heritageAvailable = 0;
        let heritageUsed = 0;

        // Variables pour les cartes sp√©ciales
        let selectedVengeanceHardship = null;
        let availableVengeanceTargets = [];

        function log(message, data) {
            console.log(`[DEBUG] ${message}`, data || '');
        }

        function showCreateGame() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('create-screen').classList.remove('hidden');
        }

        function showJoinGame() {
            document.getElementById('menu-screen').classList.add('hidden');
            document.getElementById('join-screen').classList.remove('hidden');
        }

        function backToMenu() {
            document.getElementById('create-screen').classList.add('hidden');
            document.getElementById('join-screen').classList.add('hidden');
            document.getElementById('menu-screen').classList.remove('hidden');
        }

        function showLobby() {
            document.getElementById('create-screen').classList.add('hidden');
            document.getElementById('join-screen').classList.add('hidden');
            document.getElementById('lobby-screen').classList.remove('hidden');
        }

        function showGame() {
            document.getElementById('lobby-screen').classList.add('hidden');
            document.getElementById('game-screen').classList.remove('hidden');
        }

        function showSalarySelectionModal(card, cost, availableSalaries, heritage = 0) {
            pendingAcquisitionCard = card;
            requiredCost = cost;
            selectedSalaries = [];
            heritageAvailable = heritage;
            heritageUsed = 0;
            
            const modal = document.getElementById('salary-selection-modal');
            const cardDisplay = document.getElementById('acquisition-card-display');
            const salariesList = document.getElementById('available-salaries-list');
            
            cardDisplay.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-3xl">${card.type === 'house' ? 'üè†' : '‚úàÔ∏è'}</span>
                    <div>
                        <div class="font-bold text-lg">${getCardLabel(card)}</div>
                        <div class="text-sm text-gray-600">Co√ªt minimum: ${cost} üí∞</div>
                    </div>
                </div>
            `;
            
            document.getElementById('required-cost').textContent = cost;
            document.getElementById('selected-amount').textContent = '0';
            document.getElementById('payment-status').textContent = 'S√©lectionnez vos salaires (minimum requis, vous pouvez d√©penser plus)';
            
            let salariesHTML = availableSalaries.map(salary => `
                <div onclick="toggleSalarySelection('${salary.id}', ${salary.subtype})" 
                     id="salary-${salary.id}"
                     class="salary-card-selectable p-3 bg-blue-100 border-2 border-blue-300 rounded-lg text-center">
                    <div class="text-2xl">üí∞</div>
                    <div class="font-bold">${salary.subtype}</div>
                </div>
            `).join('');
            
            // Ajouter l'h√©ritage si disponible
            if (heritage > 0) {
                salariesHTML += `
                    <div onclick="toggleHeritageSelection()" 
                         id="heritage-selector"
                         class="salary-card-selectable p-3 bg-purple-100 border-2 border-purple-300 rounded-lg text-center col-span-2">
                        <div class="text-2xl">üéÅ</div>
                        <div class="font-bold">H√©ritage: ${heritage}</div>
                        <div class="text-xs text-gray-600">Cliquez pour utiliser</div>
                    </div>
                `;
            }
            
            salariesList.innerHTML = salariesHTML;
            
            document.getElementById('confirm-salary-btn').disabled = true;
            modal.classList.remove('hidden');
        }

        function toggleSalarySelection(salaryId, salaryLevel) {
            const salaryElement = document.getElementById(`salary-${salaryId}`);
            
            const index = selectedSalaries.findIndex(s => s.id === salaryId);
            
            if (index > -1) {
                // D√©s√©lectionner
                selectedSalaries.splice(index, 1);
                salaryElement.classList.remove('salary-card-selected');
            } else {
                // S√©lectionner
                selectedSalaries.push({ id: salaryId, level: salaryLevel });
                salaryElement.classList.add('salary-card-selected');
            }
            
            updateSalarySelectionDisplay();
        }

        function toggleHeritageSelection() {
            const heritageEl = document.getElementById('heritage-selector');
            
            if (heritageUsed > 0) {
                // D√©sactiver l'h√©ritage
                heritageUsed = 0;
                heritageEl.classList.remove('salary-card-selected');
            } else {
                // Activer l'h√©ritage
                heritageUsed = heritageAvailable;
                heritageEl.classList.add('salary-card-selected');
            }
            
            updateSalarySelectionDisplay();
        }

        function updateSalarySelectionDisplay() {
            const totalSalaries = selectedSalaries.reduce((sum, s) => sum + s.level, 0);
            const total = totalSalaries + heritageUsed;
            
            document.getElementById('selected-amount').textContent = `${totalSalaries}${heritageUsed > 0 ? ` + ${heritageUsed} (h√©ritage)` : ''} = ${total}`;
            
            const statusEl = document.getElementById('payment-status');
            const confirmBtn = document.getElementById('confirm-salary-btn');
            
            if (total < requiredCost) {
                statusEl.textContent = `Il manque ${requiredCost - total} (minimum requis)`;
                statusEl.className = 'mt-2 text-sm text-orange-600 font-semibold';
                confirmBtn.disabled = true;
            } else if (total === requiredCost) {
                statusEl.textContent = '‚úÖ Montant exact !';
                statusEl.className = 'mt-2 text-sm text-green-600 font-semibold';
                confirmBtn.disabled = false;
            } else {
                statusEl.textContent = `‚úÖ Montant valide ! (+${total - requiredCost} de surplus)`;
                statusEl.className = 'mt-2 text-sm text-green-600 font-semibold';
                confirmBtn.disabled = false;
            }
        }

        function confirmSalarySelection() {
            if (!pendingAcquisitionCard || (selectedSalaries.length === 0 && heritageUsed === 0)) return;
            
            const totalSalaries = selectedSalaries.reduce((sum, s) => sum + s.level, 0);
            const total = totalSalaries + heritageUsed;
            
            if (total < requiredCost) {
                alert('Le montant s√©lectionn√© est inf√©rieur au minimum requis');
                return;
            }
            
            socket.emit('select_salaries_for_purchase', {
                card_id: pendingAcquisitionCard.id,
                salary_ids: selectedSalaries.map(s => s.id),
                use_heritage: heritageUsed
            });
            
            closeSalaryModal();
        }

        function closeSalaryModal() {
            document.getElementById('salary-selection-modal').classList.add('hidden');
            pendingAcquisitionCard = null;
            selectedSalaries = [];
            requiredCost = 0;
            heritageAvailable = 0;
            heritageUsed = 0;
        }

        function showHardshipModal(card, availableTargets, isFromDiscard = false) {
            pendingHardshipCard = card;
            fromDiscard = isFromDiscard;
            
            const modal = document.getElementById('hardship-modal');
            const cardDisplay = document.getElementById('hardship-card-display');
            const targetsList = document.getElementById('target-players-list');
            
            cardDisplay.innerHTML = `
                <div class="flex items-center gap-3">
                    <span class="text-3xl">‚ö†Ô∏è</span>
                    <div>
                        <div class="font-bold text-lg">${getCardLabel(card)}</div>
                        <div class="text-sm text-gray-600">${getHardshipDescription(card.subtype)}</div>
                    </div>
                </div>
            `;
            
            targetsList.innerHTML = availableTargets.map(target => {
                const isImmune = target.immune || false;
                const buttonClass = isImmune 
                    ? 'w-full p-4 bg-gray-400 text-gray-700 rounded-lg cursor-not-allowed opacity-50' 
                    : 'w-full p-4 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg hover:from-red-600 hover:to-orange-600 transition-all transform hover:scale-105 font-semibold shadow-lg';
                const onClick = isImmune ? '' : `onclick="selectHardshipTarget(${target.id})"`;
                const immuneText = isImmune ? ` üõ°Ô∏è (Prot√©g√©)` : '';
                
                return `
                    <button ${onClick} ${isImmune ? 'disabled' : ''} 
                            class="${buttonClass}">
                        üéØ ${target.name}${immuneText}
                    </button>
                `;
            }).join('');
            
            modal.classList.remove('hidden');
        }

        function closeHardshipModal() {
            document.getElementById('hardship-modal').classList.add('hidden');
            pendingHardshipCard = null;
            fromDiscard = false;
        }

        function selectHardshipTarget(targetId) {
            if (!pendingHardshipCard) return;
            
            log('S√©lection cible malus', {cardId: pendingHardshipCard.id, targetId});
            
            socket.emit('play_card', {
                card_id: pendingHardshipCard.id,
                target_player_id: targetId
            });
            
            closeHardshipModal();
        }

        function getHardshipDescription(type) {
            const descriptions = {
                'accident': 'Passer 1 tour',
                'burnout': 'Passer 1 tour',
                'divorce': 'Fait perdre le mariage',
                'impot': 'Fait perdre 1 salaire',
                'licenciement': 'Fait perdre le m√©tier',
                'maladie': 'Passer 1 tour',
                'redoublement': 'Fait perdre une √©tude',
                'prison': 'Passer 3 tours',
                'attentat': 'VOUS perdez tous VOS enfants !'
            };
            return descriptions[type] || 'Coup dur';
        }

        // === CARTES SP√âCIALES ===

        // ANNIVERSAIRE
        function showBirthdayModal(birthdayPlayerName, availableSalaries) {
            const modal = document.getElementById('birthday-modal');
            const message = document.getElementById('birthday-message');
            const salariesList = document.getElementById('birthday-salaries-list');
            
            message.textContent = `C'est l'anniversaire de ${birthdayPlayerName} ! Offrez-lui un salaire üéÅ`;
            
            salariesList.innerHTML = availableSalaries.map(salary => `
                <div onclick="selectBirthdayGift('${salary.id}')" 
                     class="cursor-pointer p-4 bg-blue-100 border-2 border-blue-300 rounded-lg hover:bg-blue-200 hover:scale-105 transition-all text-center">
                    <div class="text-3xl mb-2">üí∞</div>
                    <div class="font-bold text-lg">${salary.subtype}</div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function selectBirthdayGift(salaryId) {
            socket.emit('birthday_gift_selected', { salary_id: salaryId });
            document.getElementById('birthday-modal').classList.add('hidden');
        }

        // TROC
        function showTrocModal(availableTargets) {
            const modal = document.getElementById('troc-modal');
            const playersList = document.getElementById('troc-players-list');
            
            playersList.innerHTML = availableTargets.map(target => `
                <button onclick="selectTrocTarget(${target.id})" 
                        class="w-full p-4 bg-gradient-to-r from-blue-500 to-cyan-500 text-white rounded-lg hover:from-blue-600 hover:to-cyan-600 transition-all transform hover:scale-105 font-semibold shadow-lg">
                    üéØ ${target.name} (${target.hand_count} carte(s) en main)
                </button>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function selectTrocTarget(targetId) {
            socket.emit('troc_target_selected', { target_id: targetId });
            closeTrocModal();
        }

        function closeTrocModal() {
            document.getElementById('troc-modal').classList.add('hidden');
        }

        // PISTON
        function showPistonModal(availableJobs) {
            const modal = document.getElementById('piston-modal');
            const jobsList = document.getElementById('piston-jobs-list');
            
            jobsList.innerHTML = availableJobs.map(job => `
                <div onclick="selectPistonJob('${job.id}')" 
                     class="cursor-pointer p-4 bg-blue-100 border-2 border-blue-400 rounded-lg hover:bg-blue-200 hover:scale-105 transition-all">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-2xl">üíº</span>
                        <span class="font-bold">${job.subtype}</span>
                    </div>
                    <div class="text-sm text-gray-600">
                        <div>üí∞ Salaire: ${job.salary}</div>
                        <div>üìö √âtudes: ${job.studies}</div>
                        ${job.smiles > 0 ? `<div>üòä ${job.smiles}</div>` : ''}
                    </div>
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function selectPistonJob(jobId) {
            socket.emit('piston_job_selected', { job_id: jobId });
            closePistonModal();
        }

        function closePistonModal() {
            document.getElementById('piston-modal').classList.add('hidden');
        }

        // VENGEANCE
        function showVengeanceModal(receivedHardships, availableTargets) {
            const modal = document.getElementById('vengeance-modal');
            const hardshipsList = document.getElementById('vengeance-hardships-list');
            
            selectedVengeanceHardship = null;
            availableVengeanceTargets = availableTargets;
            
            hardshipsList.innerHTML = receivedHardships.map(hardship => `
                <button onclick="selectVengeanceHardship('${hardship}')" 
                        class="w-full p-3 bg-red-100 border-2 border-red-300 rounded-lg hover:bg-red-200 transition-all text-left">
                    <span class="font-semibold">‚ö†Ô∏è ${hardship}</span>
                    <div class="text-xs text-gray-600 mt-1">${getHardshipDescription(hardship)}</div>
                </button>
            `).join('');
            
            document.getElementById('vengeance-targets-container').classList.add('hidden');
            modal.classList.remove('hidden');
        }

        function selectVengeanceHardship(hardshipType) {
            selectedVengeanceHardship = hardshipType;
            
            // Afficher la liste des cibles
            const targetsContainer = document.getElementById('vengeance-targets-container');
            const targetsList = document.getElementById('vengeance-targets-list');
            
            targetsList.innerHTML = availableVengeanceTargets.map(target => `
                <button onclick="selectVengeanceTarget(${target.id})" 
                        class="w-full p-4 bg-gradient-to-r from-red-500 to-orange-500 text-white rounded-lg hover:from-red-600 hover:to-orange-600 transition-all transform hover:scale-105 font-semibold shadow-lg">
                    üéØ ${target.name}
                </button>
            `).join('');
            
            targetsContainer.classList.remove('hidden');
        }

        function selectVengeanceTarget(targetId) {
            if (!selectedVengeanceHardship) return;
            
            socket.emit('vengeance_selected', {
                hardship_type: selectedVengeanceHardship,
                target_id: targetId
            });
            
            closeVengeanceModal();
        }

        function closeVengeanceModal() {
            document.getElementById('vengeance-modal').classList.add('hidden');
            selectedVengeanceHardship = null;
            availableVengeanceTargets = [];
        }

        // CHANCE
        function showChanceModal(cards) {
            const modal = document.getElementById('chance-modal');
            const cardsList = document.getElementById('chance-cards-list');
            
            cardsList.innerHTML = cards.map(card => `
                <div onclick="selectChanceCard('${card.id}')" 
                     class="cursor-pointer transform hover:scale-105 transition-all">
                    ${createCardHTML(card, false)}
                </div>
            `).join('');
            
            modal.classList.remove('hidden');
        }

        function selectChanceCard(cardId) {
            socket.emit('chance_card_selected', { card_id: cardId });
            document.getElementById('chance-modal').classList.add('hidden');
        }

        // ARC-EN-CIEL
        function showArcEnCielMode() {
            document.getElementById('arc-en-ciel-banner').classList.remove('hidden');
            updateArcRemaining(3);
        }

        function updateArcRemaining(count) {
            document.getElementById('arc-remaining').textContent = count;
        }

        function finishArcEnCiel() {
            socket.emit('arc_en_ciel_finished', {});
            document.getElementById('arc-en-ciel-banner').classList.add('hidden');
        }

        // √âTOILE FILANTE
        function showStarModal(discardCards) {
            const modal = document.getElementById('star-modal');
            const discardList = document.getElementById('star-discard-list');
            
            if (!discardCards || discardCards.length === 0) {
                discardList.innerHTML = '<p class="col-span-full text-center text-gray-500">La d√©fausse est vide</p>';
            } else {
                discardList.innerHTML = discardCards.map(card => `
                    <div onclick="selectStarCard('${card.id}')" 
                         class="cursor-pointer transform hover:scale-105 transition-all">
                        ${createCardHTML(card, false)}
                    </div>
                `).join('');
            }
            
            modal.classList.remove('hidden');
        }

        function selectStarCard(cardId) {
            socket.emit('discard_card_selected', { card_id: cardId });
            closeStarModal();
        }

        function closeStarModal() {
            document.getElementById('star-modal').classList.add('hidden');
        }

        function createGame() {
            const playerName = document.getElementById('host-name').value || 'Joueur 1';
            const numPlayers = parseInt(document.getElementById('num-players').value);
            
            log('Cr√©ation de partie', {playerName, numPlayers});
            
            socket.emit('create_game', {
                player_name: playerName,
                num_players: numPlayers
            });
            
            isHost = true;
        }

        function joinGame() {
            const playerName = document.getElementById('join-name').value || 'Joueur';
            const gameCode = document.getElementById('game-code').value.trim().toLowerCase();
            
            if (!gameCode) {
                alert('Veuillez entrer un code de partie');
                return;
            }
            
            log('Rejoindre partie', {playerName, gameCode});
            
            socket.emit('join_game', {
                game_id: gameCode,
                player_name: playerName
            });
        }

        function startGame() {
            log('D√©marrage partie', {gameId});
            socket.emit('start_game', { game_id: gameId });
        }

        function drawCard(source) {
            log('Pioche carte', {source});
            socket.emit('draw_card', { source: source });
        }

        function skipTurn() {
            log('Passer le tour');
            socket.emit('skip_turn', {});
        }

        function playCard(cardId) {
            log('Jouer carte', {cardId});
            
            if (!currentGame || !currentGame.players[myPlayerId]) return;
            
            const myPlayer = currentGame.players[myPlayerId];
            const card = myPlayer.hand.find(c => c.id === cardId);
            
            // V√©rifier si c'est une carte sp√©ciale
            if (card && card.type === 'special') {
                // Cartes sp√©ciales qui n√©cessitent une interaction
                const specialTypes = ['anniversaire', 'troc', 'piston', 'vengeance', 'chance', 'arc en ciel', 'etoile filante', 'heritage', 'tsunami'];
                
                if (specialTypes.includes(card.subtype)) {
                    socket.emit('play_special_card', { card_id: cardId });
                    return;
                }
            }
            
            // Mode arc-en-ciel actif
            if (currentGame.pending_special && currentGame.pending_special.type === 'arc_en_ciel') {
                socket.emit('play_card', { card_id: cardId });
                
                const remaining = 3 - (currentGame.pending_special.cards_played + 1);
                updateArcRemaining(remaining);
                
                if (remaining <= 0) {
                    setTimeout(() => finishArcEnCiel(), 500);
                }
                return;
            }
            
            // Appel normal
            if (card && card.type === 'hardship') {
                socket.emit('play_card', { card_id: cardId });
            } else {
                socket.emit('play_card', { card_id: cardId });
            }
        }

        function discardCard(cardId) {
            log('D√©fausser carte', {cardId});
            socket.emit('discard_card', { card_id: cardId });
        }

        function discardPlayedCard(cardId) {
            log('D√©fausser carte pos√©e', {cardId});
            
            // V√©rifier qu'on est en phase draw
            if (currentGame.phase !== 'draw') {
                alert('Vous ne pouvez d√©fausser qu\'avant de piocher');
                return;
            }
            
            if (confirm('√ätes-vous s√ªr de vouloir d√©fausser cette carte ?')) {
                socket.emit('discard_played_card', { card_id: cardId });
            }
        }

        socket.on('game_created', (data) => {
            log('Partie cr√©√©e', data);
            gameId = data.game_id;
            myPlayerId = data.player_id;
            currentGame = data.game;
            
            document.getElementById('lobby-game-code').textContent = gameId.toUpperCase();
            showLobby();
            updateLobby();
            
            if (isHost) {
                document.getElementById('start-button-container').classList.remove('hidden');
            }
        });

        socket.on('game_joined', (data) => {
            log('Partie rejointe', data);
            gameId = data.game_id;
            myPlayerId = data.player_id;
            currentGame = data.game;
            
            document.getElementById('lobby-game-code').textContent = gameId.toUpperCase();
            showLobby();
            updateLobby();
        });

        socket.on('player_joined', (data) => {
            log('Joueur rejoint', data);
            updateMessage(`${data.player_name} a rejoint la partie !`);
            if (!document.getElementById('lobby-screen').classList.contains('hidden')) {
                updateLobby();
            }
        });

        socket.on('player_disconnected', (data) => {
            log('Joueur d√©connect√©', data);
            updateMessage(`${data.player_name} s'est d√©connect√©`);
        });

        socket.on('game_started', (data) => {
            log('Partie d√©marr√©e', data);
            currentGame = data.game;
            showGame();
            updateGameDisplay();
        });

        socket.on('game_updated', (data) => {
            log('Jeu mis √† jour', data);
            currentGame = data.game;
            updateGameDisplay();
            
            if (data.message) {
                updateMessage(data.message);
            }
        });

        socket.on('select_hardship_target', (data) => {
            log('S√©lectionner cible malus', data);
            showHardshipModal(data.card, data.available_targets, data.from_discard || false);
        });

        socket.on('select_salaries_for_acquisition', (data) => {
            log('S√©lectionner salaires pour acquisition', data);
            showSalarySelectionModal(data.card, data.required_cost, data.available_salaries, data.heritage_available || 0);
        });

        // √âcouteurs pour les cartes sp√©ciales
        socket.on('select_birthday_gift', (data) => {
            log('Anniversaire - s√©lection cadeau', data);
            showBirthdayModal(data.birthday_player_name, data.available_salaries);
        });

        socket.on('select_troc_target', (data) => {
            log('Troc - s√©lection cible', data);
            showTrocModal(data.available_targets);
        });

        socket.on('select_piston_job', (data) => {
            log('Piston - s√©lection m√©tier', data);
            showPistonModal(data.available_jobs);
        });

        socket.on('select_vengeance', (data) => {
            log('Vengeance - s√©lection', data);
            showVengeanceModal(data.received_hardships, data.available_targets);
        });

        socket.on('select_chance_card', (data) => {
            log('Chance - s√©lection carte', data);
            showChanceModal(data.cards);
        });

        socket.on('arc_en_ciel_mode', (data) => {
            log('Arc-en-ciel - mode activ√©', data);
            showArcEnCielMode();
        });

        socket.on('select_from_discard', (data) => {
            log('√âtoile filante - s√©lection d√©fausse', data);
            showStarModal(data.discard_cards);
        });

        socket.on('game_over', (data) => {
            log('Partie termin√©e', data);
            showEndScreen(data.scores);
        });

        socket.on('error', (data) => {
            log('Erreur re√ßue', data);
            alert('Erreur: ' + data.message);
        });

        function updateLobby() {
            if (!currentGame) {
                log('updateLobby: pas de currentGame');
                return;
            }
            
            log('Mise √† jour lobby', currentGame);
            
            const container = document.getElementById('lobby-players');
            container.innerHTML = currentGame.players.map((player, i) => {
                const status = player.connected ? '‚úÖ Connect√©' : '‚è≥ En attente...';
                const isYou = i === myPlayerId ? ' (Vous)' : '';
                const color = player.connected ? 'bg-green-100' : 'bg-gray-100';
                
                return `
                    <div class="flex items-center justify-between p-3 ${color} rounded-lg">
                        <span class="font-semibold">${player.name}${isYou}</span>
                        <span class="text-sm">${status}</span>
                    </div>
                `;
            }).join('');
            
            const connectedCount = currentGame.players.filter(p => p.connected).length;
            document.getElementById('players-count').textContent = 
                `${connectedCount} / ${currentGame.num_players} joueurs connect√©s`;
            
            if (isHost && connectedCount >= 2) {
                document.querySelector('#start-button-container button').disabled = false;
            }
        }

        function updateGameDisplay() {
            if (!currentGame) {
                log('updateGameDisplay: pas de currentGame');
                return;
            }
            
            log('Mise √† jour affichage jeu', {
                deck: currentGame.deck_count,
                discard: currentGame.discard ? currentGame.discard.length : 0,
                phase: currentGame.phase,
                currentPlayer: currentGame.current_player,
                myId: myPlayerId
            });
            
            const myPlayer = currentGame.players[myPlayerId];
            const currentPlayer = currentGame.players[currentGame.current_player];
            const isMyTurn = currentGame.current_player === myPlayerId;
            
            document.getElementById('current-player-name').textContent = 
                isMyTurn ? '√Ä vous de jouer !' : `Tour de ${currentPlayer.name}`;
            document.getElementById('deck-count').textContent = currentGame.deck_count || 0;
            document.getElementById('discard-count').textContent = currentGame.discard ? currentGame.discard.length : 0;
            
            // Afficher la derni√®re carte d√©fauss√©e
            if (currentGame.last_discard) {
                document.getElementById('last-discard-container').classList.remove('hidden');
                document.getElementById('last-discard-card').innerHTML = createCardHTML(currentGame.last_discard, false);
            } else {
                document.getElementById('last-discard-container').classList.add('hidden');
            }
            
            // Afficher l'h√©ritage si disponible
            if (myPlayer.heritage > 0) {
                const heritageDisplay = `
                    <div class="bg-purple-100 border-2 border-purple-300 rounded-lg p-3 mb-4">
                        <div class="flex items-center gap-2">
                            <span class="text-2xl">üéÅ</span>
                            <div>
                                <div class="font-bold">H√©ritage disponible</div>
                                <div class="text-lg text-purple-600">${myPlayer.heritage} üí∞</div>
                            </div>
                        </div>
                    </div>
                `;
                if (!document.getElementById('heritage-display')) {
                    const actionsPanel = document.getElementById('actions-panel');
                    const heritageDiv = document.createElement('div');
                    heritageDiv.id = 'heritage-display';
                    heritageDiv.innerHTML = heritageDisplay;
                    actionsPanel.parentNode.insertBefore(heritageDiv, actionsPanel.nextSibling);
                } else {
                    document.getElementById('heritage-display').innerHTML = heritageDisplay;
                }
            } else {
                const heritageDiv = document.getElementById('heritage-display');
                if (heritageDiv) {
                    heritageDiv.remove();
                }
            }
            
            if (isMyTurn) {
                if (myPlayer.skip_turns > 0) {
                    updateMessage(`‚è∏Ô∏è Vous devez passer votre tour (${myPlayer.skip_turns} tour(s) restant(s)) - Cliquez sur "Passer mon tour"`);
                } else if (currentGame.phase === 'draw') {
                    updateMessage('Piochez une carte de la pioche ou de la d√©fausse (ou d√©faussez un m√©tier/mariage/adult√®re avant, ou passez votre tour)');
                } else {
                    updateMessage('Jouez ou d√©faussez une carte de votre main (ou passez votre tour)');
                }
            } else {
                updateMessage(`En attente de ${currentPlayer.name}...`);
            }
            
            const canDraw = isMyTurn && currentGame.phase === 'draw' && myPlayer.skip_turns === 0;
            const canPlay = isMyTurn && currentGame.phase === 'play';
            const canSkipVoluntarily = isMyTurn;
            const canDiscardPlayed = isMyTurn && currentGame.phase === 'draw' && myPlayer.skip_turns === 0;
            
            document.getElementById('draw-deck-btn').disabled = !canDraw;
            document.getElementById('draw-discard-btn').disabled = !canDraw || (currentGame.discard && currentGame.discard.length === 0);
            document.getElementById('skip-turn-btn').disabled = !canSkipVoluntarily;
            
            const scoresContainer = document.getElementById('players-scores');
            scoresContainer.innerHTML = currentGame.players.map((player, i) => {
                const smiles = calculateSmiles(player);
                const isCurrent = i === currentGame.current_player;
                const isMe = i === myPlayerId;
                const bgColor = isCurrent ? 'bg-yellow-400 shadow-lg transform scale-105' : 
                                isMe ? 'bg-blue-100' : 'bg-white';
                
                return `
                    <div class="p-3 rounded-lg ${bgColor}">
                        <div class="font-bold text-sm">${player.name}${isMe ? ' (Vous)' : ''}</div>
                        <div class="flex items-center gap-1 text-lg">
                            <span>üòä</span>
                            <span>${smiles}</span>
                        </div>
                        ${player.skip_turns > 0 ? `<div class="text-xs text-orange-600">‚è∏Ô∏è ${player.skip_turns} tour(s)</div>` : ''}
                        ${!player.connected ? '<div class="text-xs text-red-600">D√©connect√©</div>' : ''}
                    </div>
                `;
            }).join('');
            
            log('Main du joueur', myPlayer.hand);
            const handContainer = document.getElementById('player-hand');
            document.getElementById('hand-count').textContent = myPlayer.hand ? myPlayer.hand.length : 0;
            
            if (myPlayer.hand && myPlayer.hand.length > 0) {
                handContainer.innerHTML = myPlayer.hand.map(card => {
                    return createCardHTML(card, canPlay);
                }).join('');
            } else {
                handContainer.innerHTML = '<p class="text-gray-500">Aucune carte en main</p>';
            }
            
            // Afficher les cartes par cat√©gories
            displayPlayerCategories(myPlayer, canDiscardPlayed);
            
            // Afficher les attaques re√ßues
            const hardshipsContainer = document.getElementById('hardships-received');
            if (myPlayer.received_hardships && myPlayer.received_hardships.length > 0) {
                hardshipsContainer.innerHTML = myPlayer.received_hardships.map(hardship => {
                    return `
                        <div class="bg-red-200 border-2 border-red-400 rounded-lg p-2 text-sm">
                            <span class="font-semibold">‚ö†Ô∏è ${hardship}</span>
                        </div>
                    `;
                }).join('');
            } else {
                hardshipsContainer.innerHTML = '<p class="text-gray-500">Aucune attaque re√ßue</p>';
            }
            
            const othersContainer = document.getElementById('other-players');
            othersContainer.innerHTML = currentGame.players
                .filter((_, i) => i !== myPlayerId)
                .map(player => {
                    const handCount = player.hand_count || (player.hand ? player.hand.length : 0);
                    return `
                        <div class="bg-white rounded-lg shadow-lg p-4">
                            <h3 class="font-bold mb-3">
                                ${player.name} 
                                ${player.connected ? '' : '<span class="text-red-600 text-sm">(D√©connect√©)</span>'}
                                ${player.skip_turns > 0 ? `<span class="text-orange-600 text-sm">(‚è∏Ô∏è ${player.skip_turns} tour(s))</span>` : ''}
                            </h3>
                            <div class="text-sm text-gray-600 mb-2">${handCount} cartes en main</div>
                            
                            ${player.received_hardships && player.received_hardships.length > 0 ? `
                                <div class="mb-2">
                                    <div class="text-xs font-semibold text-red-700 mb-1">Attaques re√ßues:</div>
                                    <div class="flex flex-wrap gap-1">
                                        ${player.received_hardships.map(h => `<span class="bg-red-200 text-xs px-2 py-1 rounded">‚ö†Ô∏è ${h}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                            
                            ${displayOtherPlayerCategories(player)}
                        </div>
                    `;
                }).join('');
        }

        function displayPlayerCategories(player, canDiscard) {
            const categories = {
                'vie professionnelle': 'player-vie-pro',
                'vie personnelle': 'player-vie-perso',
                'acquisitions': 'player-acquisitions',
                'salaire d√©pens√©': 'player-salaire-depense',
                'cartes sp√©ciales': 'player-speciales'
            };
            
            for (const [category, elementId] of Object.entries(categories)) {
                const container = document.getElementById(elementId);
                const cards = player.played[category] || [];
                
                if (cards.length > 0) {
                    const canDiscardThisCategory = canDiscard && (category === 'vie professionnelle' || category === 'vie personnelle');
                    container.innerHTML = cards.map(card => {
                        return createCardHTML(card, false, true, canDiscardThisCategory);
                    }).join('');
                } else {
                    container.innerHTML = '<p class="text-gray-500 text-sm">Aucune carte</p>';
                }
            }
        }

        function displayOtherPlayerCategories(player) {
            const categoryIcons = {
                'vie professionnelle': 'üíº',
                'vie personnelle': 'üíï',
                'acquisitions': 'üè†',
                'salaire d√©pens√©': 'üí∏',
                'cartes sp√©ciales': '‚≠ê'
            };
            
            let html = '';
            
            for (const [category, icon] of Object.entries(categoryIcons)) {
                const cards = player.played[category] || [];
                if (cards.length > 0) {
                    html += `
                        <div class="mb-2">
                            <div class="text-xs font-semibold text-gray-700 mb-1">${icon} ${category}</div>
                            <div class="flex flex-wrap gap-1">
                                ${cards.map(card => createCardHTML(card, false, false, false, true)).join('')}
                            </div>
                        </div>
                    `;
                }
            }
            
            return html || '<p class="text-gray-500">Aucune carte pos√©e</p>';
        }

        function createCardHTML(card, canPlay, isPlayed = false, canDiscard = false, isSmall = false) {
            const colors = {
                'job': 'bg-blue-100 border-blue-300',
                'study': 'bg-blue-100 border-blue-300',
                'salary': 'bg-blue-100 border-blue-300',
                'flirt': 'bg-pink-100 border-pink-300',
                'marriage': 'bg-pink-100 border-pink-300',
                'child': 'bg-pink-100 border-pink-300',
                'animal': 'bg-pink-100 border-pink-300',
                'adultere': 'bg-pink-100 border-pink-300',
                'house': 'bg-green-100 border-green-300',
                'travel': 'bg-green-100 border-green-300',
                'hardship': 'bg-red-100 border-red-300',
                'special': 'bg-yellow-100 border-yellow-300',
                'other': 'bg-purple-100 border-purple-300'
            };

            const icons = {
                'job': 'üíº', 'study': 'üìö', 'salary': 'üí∞',
                'flirt': 'üíï', 'marriage': 'üíç', 'child': 'üë∂',
                'animal': 'üêæ', 'adultere': 'üíî', 'house': 'üè†',
                'travel': '‚úàÔ∏è', 'hardship': '‚ö†Ô∏è', 'special': '‚≠ê', 'other': 'üéñ'
            };

            const label = getCardLabel(card);
            const color = colors[card.type] || 'bg-gray-100 border-gray-300';
            const icon = icons[card.type] || 'üé¥';
            
            const cursor = (canPlay || canDiscard) ? 'cursor-pointer hover:scale-105' : '';
            const sizeClass = isSmall ? 'min-w-[80px] p-2' : 'min-w-[120px] p-3';
            const textSize = isSmall ? 'text-xs' : 'text-sm';
            
            // Permettre de d√©fausser m√©tier, mariage et adult√®re d√©j√† pos√©s (AVANT de piocher)
            const canDiscardPlayed = isPlayed && canDiscard && (card.type === 'job' || card.type === 'marriage' || card.type === 'adultere');

            return `
                <div class="card ${color} border-2 rounded-lg ${sizeClass} ${cursor}">
                    <div class="flex items-center gap-2 mb-1">
                        <span class="${isSmall ? 'text-sm' : ''}">${icon}</span>
                        <span class="font-semibold ${textSize}">${label}</span>
                    </div>
                    ${card.smiles > 0 ? `
                        <div class="flex items-center gap-1 text-yellow-600">
                            <span class="${isSmall ? 'text-xs' : ''}">üòä</span>
                            <span class="${textSize}">${card.smiles}</span>
                        </div>
                    ` : ''}
                    ${canPlay ? `
                        <div class="mt-2 flex gap-1">
                            <button onclick="playCard('${card.id}')" class="flex-1 ${card.type === 'hardship' ? 'bg-red-500 hover:bg-red-600' : card.type === 'special' ? 'bg-yellow-500 hover:bg-yellow-600' : 'bg-green-500 hover:bg-green-600'} text-white text-xs px-2 py-1 rounded">
                                ${card.type === 'hardship' ? 'Attaquer' : card.type === 'special' ? '‚≠ê Activer' : 'Jouer'}
                            </button>
                            <button onclick="discardCard('${card.id}')" class="flex-1 bg-gray-500 text-white text-xs px-2 py-1 rounded hover:bg-gray-600">
                                D√©fausser
                            </button>
                        </div>
                    ` : ''}
                    ${canDiscardPlayed ? `
                        <div class="mt-2">
                            <button onclick="discardPlayedCard('${card.id}')" class="w-full bg-red-500 text-white text-xs px-2 py-1 rounded hover:bg-red-600">
                                üóëÔ∏è D√©fausser
                            </button>
                        </div>
                    ` : ''}
                </div>
            `;
        }
        

        function getCardLabel(card) {
            if (card.type === 'job') return card.subtype;
            if (card.type === 'study') return card.subtype === 'double' ? '√âtudes x2' : '√âtudes';
            if (card.type === 'salary') return `Salaire ${card.subtype}`;
            if (card.type === 'flirt') return `Flirt (${card.subtype})`;
            if (card.type === 'marriage') return `Mariage (${card.subtype})`;
            if (card.type === 'child') return card.subtype;
            if (card.type === 'animal') return card.subtype;
            if (card.type === 'house') return `Maison ${card.subtype}`;
            if (card.type === 'travel') return 'Voyage';
            if (card.type === 'hardship') return card.subtype;
            if (card.type === 'special') return card.subtype;
            if (card.type === 'adultere') return 'Adult√®re';
            if (card.type === 'other') {
                if (card.subtype === 'legion') return "L√©gion d'honneur";
                if (card.subtype === 'prix') return 'Grand Prix';
            }
            return 'Carte';
        }

        function calculateSmiles(player) {
            let total = 0;
            
            // Calculer depuis toutes les cat√©gories
            for (const category in player.played) {
                const cards = player.played[category];
                total += cards.reduce((sum, card) => sum + (card.smiles || 0), 0);
            }
            
            // V√©rifier le bonus licorne + arc-en-ciel + √©toile
            let allCards = [];
            for (const category in player.played) {
                allCards = allCards.concat(player.played[category]);
            }
            
            const hasLicorne = allCards.some(c => c.type === 'animal' && c.subtype === 'licorne');
            const hasArc = allCards.some(c => c.type === 'special' && c.subtype === 'arc en ciel');
            const hasEtoile = allCards.some(c => c.type === 'special' && c.subtype === 'etoile filante');
            
            if (hasLicorne && hasArc && hasEtoile) {
                total += 3;
            }
            
            return total;
        }

        function updateMessage(msg) {
            const messageEl = document.getElementById('message');
            messageEl.textContent = msg;
            messageEl.classList.remove('hidden');
        }

        function showEndScreen(scores) {
            document.getElementById('game-screen').classList.add('hidden');
            document.getElementById('end-screen').classList.remove('hidden');
            
            document.getElementById('winner-name').textContent = `Gagnant : ${scores[0][0]}`;
            
            const medals = ['ü•á', 'ü•à', 'ü•â'];
            const scoresHTML = scores.map((score, i) => {
                const medal = medals[i] || `#${i + 1}`;
                const bgColor = i === 0 ? 'bg-gradient-to-r from-yellow-200 to-yellow-300 border-4 border-yellow-500' :
                                i === 1 ? 'bg-gray-200 border-2 border-gray-400' :
                                i === 2 ? 'bg-orange-200 border-2 border-orange-400' :
                                'bg-white border-2 border-gray-300';
                
                return `
                    <div class="p-6 rounded-lg ${bgColor}">
                        <div class="flex justify-between items-center">
                            <div class="flex items-center gap-4">
                                <div class="text-3xl font-bold">${medal}</div>
                                <div>
                                    <div class="text-2xl font-bold">${score[0]}</div>
                                    <div class="flex items-center gap-2 text-xl">
                                        <span>üòä</span>
                                        <span class="font-bold text-yellow-600">${score[1]} smiles</span>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
            
            document.getElementById('final-scores').innerHTML = scoresHTML;
        }
    </script>
</body>
</html>